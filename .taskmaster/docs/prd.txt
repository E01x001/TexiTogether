📄 Product Requirements Document: Texitogether (Taxi Together)
프로젝트 명: Texitogether (TT)

버전: 2.0

상태: 개발 진행 중 (In Progress)

작성일: 2025년 12월 29일

최종 수정: 2025년 12월 29일

## 현재 프로젝트 상태 (Current Status)

**진행률**: 30% (기반 설정 완료, 핵심 기능 미착수)

**완료된 항목** (✅):
- Expo 프로젝트 초기화 및 TypeScript 설정
- Supabase 클라이언트 통합 (플랫폼별 스토리지 처리)
- 데이터베이스 스키마 설계 완료 (로컬 migration 파일)
- SMS OTP 기반 전화번호 인증 시스템
- 인증 상태 관리 및 자동 라우팅
- 프로필 자동 생성 트리거

**진행 중인 작업** (🚧):
- Supabase migration을 실제 프로젝트에 적용 필요
- 메인 화면이 아직 템플릿 상태 (실제 기능 미구현)

**긴급 해결 필요** (🔴):
- Supabase 스키마 캐시 오류: `Could not find the table 'public.profiles'`
- 로컬 migration 파일을 Supabase 프로젝트에 푸시 필요

1. 제품 개요 (Product Overview)
목적: 평택역과 캠프 험프리스(워킹게이트, CPX 등) 구간을 오가는 부대 구성원들이 택시를 함께 타고 요금을 나누는 동승 매칭 플랫폼.

핵심 가치: 1인당 이동 비용의 획기적 절감(최대 75%), 안전한 신분 기반 커뮤니티, 정산 스트레스 해소.

차별점: 직접 결제 시스템 없이 딥링크(Toss, PayPal)를 활용한 '정산 보조' 모델로 법적 리스크 최소화 및 개발 속도 확보.

2. 타겟 사용자 (Target Audience)
미군 (US Army): 한국 택시 앱 사용 및 한국어 소통이 어려운 인원. 달러(PayPal/Venmo) 정산 선호.

카투사 (KATUSA): 한국 금융 앱 사용에 능숙하며 주로 방장(Host) 역할을 수행하여 택시 호출을 담당.

군무원 및 민간인 (Civilian/Contractors): 부대 정기 출입자이나 군 이메일이 없는 경우를 포함.

3. 기능적 요구사항 (Functional Requirements)
3.1 신뢰 기반 인증 시스템 (Multi-layer Verification)
휴대폰 인증: SMS OTP를 통한 본인 확인 (노쇼 방지용).

신분 정보 입력: 이름, 소속(Mil/KATUSA/Civil), DOD ID(선택) 직접 입력.

출입증 인증: CAC 또는 DBIDS 카드 사진 업로드 후 관리자 수동 승인.

인증 배지: 단계별 인증 완료 시 프로필 옆에 Verified 마크 표시.

3.2 실시간 매칭 (Party Matching)
방 생성: 출발/목적지(평택역 ↔ 게이트), 출발 시간, 모집 인원(최대 4인) 설정.

방 목록: 현재 활성화된 방을 실시간으로 확인하고 필터링(결제 수단별).

참여/탈퇴: 실시간으로 방에 참여하고 정원이 차면 자동으로 모집 마감.

3.3 정산 보조 계산기 (Settlement Helper)
1/N 자동 계산: 방장이 최종 미터기 요금을 입력하면 인원수대로 자동 분할.

송금 딥링크: * 한국 유저: 토스, 카카오페이 앱 자동 호출.

미국 유저: PayPal.Me 또는 Venmo 링크 생성 및 연결.

3.4 실시간 채팅 (Real-time Chat)
커뮤니케이션: 매칭된 인원 간 픽업 위치 조율을 위한 실시간 메시징.

번역 기능 (Phase 2): 한/영 언어 장벽 해소를 위한 간단한 번역 레이어 추가.

4. 데이터베이스 및 기술 요구사항 (Technical Requirements)
4.1 데이터베이스 설계 (Supabase)
profiles: 사용자 인증 정보 및 평판 점수 관리.

rooms: 동승 매칭 정보 및 상태 관리.

room_members: 방과 사용자의 N:M 관계 매칭.

4.2 시스템 아키텍처
플랫폼: Expo (React Native)를 통한 iOS/Android 동시 지원.

지도: Google Maps API를 통한 경로 및 게이트 위치 최적화.

5. 개발 로드맵 및 우선순위 (Development Roadmap & Priorities)

## Phase 1: 인프라 및 인증 (완료 ✅)
**기간**: 완료
**상태**: ✅ 100% 완료

완료된 작업:
- ✅ Expo 프로젝트 설정 및 TypeScript 구성
- ✅ Supabase 클라이언트 통합
- ✅ 데이터베이스 스키마 설계 (profiles, rooms, room_members)
- ✅ SMS OTP 인증 시스템 구현
- ✅ 인증 라우팅 및 세션 관리
- ✅ 프로필 자동 생성 트리거

긴급 조치 필요:
- 🔴 Supabase DB migration 푸시 및 스키마 적용

## Phase 2: MVP 핵심 기능 (진행 중 🚧)
**목표 기간**: 2-3주
**우선순위**: HIGH
**의존성**: Phase 1 완료

핵심 작업:
1. 🔴 **Task 5: 실시간 방 목록 화면** (최우선)
   - Supabase Realtime을 이용한 recruiting 상태 방 표시
   - FlatList 기반 UI 구현
   - 필터링 및 정렬 기능

2. 🟡 **Task 6: 방 생성 기능**
   - 출발/목적지 선택 (Pyeongtaek Station, Walking Gate, CPX)
   - 출발 시간 및 정원 설정
   - Supabase RPC 함수 `create_room` 구현

3. 🟡 **Task 7: 방 참가/퇴장 로직**
   - `join_room`, `leave_room` RPC 함수
   - 실시간 참가자 수 업데이트
   - 정원 초과 방지 로직

병렬 작업 가능:
4. 🟢 **Task 4: 프로필 관리 및 ID 검증**
   - 프로필 정보 입력/수정
   - CAC/DBIDS 카드 사진 업로드
   - 검증 상태 배지 표시

## Phase 3: 커뮤니케이션 및 정산 (예정 📅)
**목표 기간**: 3-4주 후
**우선순위**: MEDIUM
**의존성**: Phase 2 완료

작업:
5. **Task 8: 실시간 채팅**
   - `messages` 테이블 생성
   - react-native-gifted-chat 통합
   - 방별 채팅 구독

6. **Task 9: 정산 도우미**
   - 1/N 요금 계산기
   - Toss/PayPal/Venmo 딥링크 생성
   - 결제 정보 관리

## Phase 4: 부가 기능 및 최적화 (예정 📅)
**목표 기간**: 5-6주 후
**우선순위**: LOW
**의존성**: Phase 3 완료

작업:
7. **Task 10: Google Maps 통합**
   - react-native-maps 설치
   - 출발/도착 위치 마커 표시
   - 경로 시각화

8. **추가 최적화**
   - 오프라인 지원
   - 에러 처리 개선 (Toast/Snackbar)
   - 성능 최적화
   - Supabase 타입 생성

## Phase 5: 테스트 및 배포 (예정 📅)
**목표 기간**: 7-8주 후
**우선순위**: HIGH

작업:
- 부대 내 베타 테스트 그룹 운영
- 버그 수정 및 피드백 반영
- App Store / Google Play 배포 준비

6. 성공 지표 (Success Metrics)
매칭 완료율: 생성된 방 중 실제 주행까지 이어진 비율 70% 이상.

평균 절감 비용: 사용자 1인당 회당 최소 10,000원 이상의 비용 절감 효과 체감.

사용자 만족도: 정산 과정의 편의성에 대한 만족도 4.5/5.0 이상.

7. 기술적 리스크 및 해결 전략 (Technical Risks & Mitigation)

## 식별된 리스크

### 1. Supabase Realtime 복잡도 (Medium Risk)
**문제**: Task 5, 7, 8에서 여러 테이블의 실시간 구독 관리 복잡도 증가
**완화 전략**:
- 각 화면별로 독립적인 채널 구독
- useEffect cleanup 함수로 메모리 누수 방지
- Debouncing으로 과도한 리렌더링 방지

### 2. RLS 정책 성능 (Medium Risk)
**문제**: 멀티테이블 조인 시 RLS 검증으로 인한 쿼리 성능 저하 가능
**완화 전략**:
- RPC 함수로 복잡한 쿼리 캡슐화
- 인덱스 최적화
- 필요시 Materialized View 활용

### 3. 딥링크 호환성 (Low Risk)
**문제**: Toss/PayPal 앱이 설치되지 않은 사용자 처리
**완화 전략**:
- `Linking.canOpenURL()` 사전 확인
- 앱 미설치 시 웹 브라우저 fallback
- 명확한 안내 메시지 제공

### 4. 아키텍처 개선 필요 (Medium Risk)
**문제**: 현재 각 화면에서 Supabase 직접 호출로 코드 중복 및 유지보수성 저하
**완화 전략**:
```
src/
  services/
    roomService.ts      # 방 관련 비즈니스 로직 분리
    authService.ts      # 인증 로직 캡슐화
    chatService.ts      # 채팅 로직 관리
  hooks/
    useRooms.ts         # 방 목록 상태 관리
    useRoom.ts          # 개별 방 상태 관리
    useChat.ts          # 채팅 메시지 관리
```

### 5. 누락된 핵심 기능 (High Priority)
**문제**:
- 전역 에러 처리 시스템 부재 (현재 Alert만 사용)
- 로딩 상태 관리 미흡
- 오프라인 대응 전략 없음
- Supabase 타입 자동 생성 미완료

**해결 계획**:
- Phase 2에서 Toast/Snackbar 시스템 도입
- 전역 상태 관리 (Zustand 또는 Context API)
- Phase 4에서 오프라인 큐잉 구현
- `supabase gen types` 통합

8. 다음 단계 액션 아이템 (Immediate Action Items)

## 긴급 (이번 주 내)
- [ ] Supabase migration 파일을 프로젝트에 푸시
- [ ] 스키마 캐시 오류 해결 및 연결 테스트
- [ ] Task 5 착수: RoomListScreen 스캐폴딩

## 단기 (1-2주)
- [ ] Task 5 완료: 실시간 방 목록 화면
- [ ] Task 6 착수 및 완료: 방 생성 기능
- [ ] Task 7 착수: 참가/퇴장 로직
- [ ] 서비스 레이어 아키텍처 구현

## 중기 (3-4주)
- [ ] Task 4 완료: 프로필 관리
- [ ] Task 8 착수: 실시간 채팅
- [ ] 에러 처리 및 로딩 시스템 개선

9. 개발 환경 및 도구 (Development Environment)

**프레임워크**: Expo SDK 54.0
**언어**: TypeScript 5.9
**백엔드**: Supabase (PostgreSQL + Realtime)
**인증**: Supabase Auth (SMS OTP)
**스토리지**: Supabase Storage (ID 카드 이미지)
**상태 관리**: React Hooks (향후 Zustand 고려)
**내비게이션**: Expo Router 6.0 (File-based routing)
**스타일링**: React Native StyleSheet
**지도**: Google Maps API (react-native-maps)
**채팅 UI**: react-native-gifted-chat (예정)
**딥링크**: React Native Linking API

**개발 도구**:
- Task Master AI: 프로젝트 관리 및 작업 추적
- GitHub MCP Server: 버전 관리
- Supabase MCP Server: 데이터베이스 관리